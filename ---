--// ===== CONFIG ===== //--
getgenv().AutoPunch = true        -- เปิด/ปิดตีผู้เล่น
local RANGE = 50                   -- ระยะชก
local CHECK_TIME = 0.1             -- เวลาเช็คผู้เล่น
local ESP_TIME = 0.5               -- เวลาเช็คไอเทม

-- ไอเทมใน Workspace ที่ทำ ESP + สี
local DROP_ITEMS = {
    ["M9"] = Color3.fromRGB(0,150,255),        
    ["KeyCard"] = Color3.fromRGB(255,215,0),   
    ["Key card"] = Color3.fromRGB(255,215,0)
}

--// ===== SERVICES ===== --
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

--// ===== REMOTE ===== --
local event = RS:WaitForChild("meleeEvent")

--// ===== LOCAL PLAYER ===== --
local LP = Players.LocalPlayer
local Char = LP.Character or LP.CharacterAdded:Wait()
LP.CharacterAdded:Connect(function(c) Char = c end)

--// ===== AUTO PUNCH ===== --
task.spawn(function()
    while task.wait(CHECK_TIME) do
        if not getgenv().AutoPunch then continue end
        local HRP = Char and Char:FindFirstChild("HumanoidRootPart")
        if not HRP then continue end

        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= LP and plr.Character then
                local tHRP = plr.Character:FindFirstChild("HumanoidRootPart")
                local tHum = plr.Character:FindFirstChild("Humanoid")
                if tHRP and tHum and tHum.Health > 0 then
                    local dist = (HRP.Position - tHRP.Position).Magnitude
                    if dist <= RANGE then
                        pcall(function()
                            event:FireServer(plr)
                        end)
                    end
                end
            end
        end
    end
end)

--// ===== ITEM ESP ===== --
local function addESP(obj, color)
    if obj:FindFirstChild("ITEM_ESP") then return end

    local hl = Instance.new("Highlight")
    hl.Name = "ITEM_ESP"
    hl.FillColor = color
    hl.FillTransparency = 0.7
    hl.OutlineColor = color
    hl.Adornee = obj
    hl.Parent = obj

    local bb = Instance.new("BillboardGui")
    bb.Name = "ITEM_ESP"
    bb.Size = UDim2.new(0,120,0,22)
    bb.Adornee = obj
    bb.AlwaysOnTop = true
    bb.Parent = obj

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextColor3 = color
    label.TextStrokeTransparency = 0.4
    label.Font = Enum.Font.SourceSansBold
    label.TextScaled = true
    label.Text = obj.Name
    label.Parent = bb
end

task.spawn(function()
    while task.wait(ESP_TIME) do
        for _, obj in ipairs(Workspace:GetChildren()) do
            if DROP_ITEMS[obj.Name] and obj:IsA("Model") then
                addESP(obj, DROP_ITEMS[obj.Name])
            end
        end
    end
end)

--// ===== PLAYER ESP ===== --
local Camera = workspace.CurrentCamera
local playerESP = {}

local function makeESP(plr)
    local box = Drawing.new("Square")
    box.Thickness = 2
    box.Filled = false
    box.Visible = false

    local nameTag = Drawing.new("Text")
    nameTag.Size = 16
    nameTag.Center = true
    nameTag.Outline = true
    nameTag.Visible = false

    local hpTag = Drawing.new("Text")
    hpTag.Size = 14
    hpTag.Center = true
    hpTag.Outline = true
    hpTag.Color = Color3.fromRGB(0,255,0)
    hpTag.Visible = false

    playerESP[plr] = {Box=box, Name=nameTag, HP=hpTag}
end

local function removeESP(plr)
    if playerESP[plr] then
        for _, v in pairs(playerESP[plr]) do v:Remove() end
        playerESP[plr] = nil
    end
end

for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= LP then makeESP(plr) end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LP then makeESP(plr) end
end)

Players.PlayerRemoving:Connect(removeESP)

RunService.RenderStepped:Connect(function()
    for plr, data in pairs(playerESP) do
        local char = plr.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if char and hum and hrp and hum.Health > 0 then
            local pos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                local top,_ = Camera:WorldToViewportPoint(hrp.Position + Vector3.new(0,3,0))
                local bottom,_ = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0,3,0))
                local height = math.abs(top.Y - bottom.Y)
                local width = height / 2

                local teamColor = plr.Team and plr.Team.TeamColor.Color or Color3.fromRGB(255,255,255)

                data.Box.Size = Vector2.new(width,height)
                data.Box.Position = Vector2.new(pos.X - width/2,pos.Y - height/2)
                data.Box.Color = teamColor
                data.Box.Visible = true

                data.Name.Text = plr.Name
                data.Name.Position = Vector2.new(pos.X,pos.Y - height/2 - 15)
                data.Name.Color = teamColor
                data.Name.Visible = true

                data.HP.Text = tostring(math.floor(hum.Health))
                data.HP.Position = Vector2.new(pos.X,pos.Y + height/2 + 5)
                data.HP.Visible = true
            else
                data.Box.Visible = false
                data.Name.Visible = false
                data.HP.Visible = false
            end
        else
            data.Box.Visible = false
            data.Name.Visible = false
            data.HP.Visible = false
        end
    end
end)
